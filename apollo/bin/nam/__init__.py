import argparse
import pkgutil
import textwrap
from pathlib import Path


def iter_subcommands():
    '''Iterate over the available subcommands.
    '''
    path = Path(__file__).parent
    for modinfo in pkgutil.iter_modules([path]):
        name = modinfo.name
        if not name.startswith('_'):
            yield name


def call_subcommand(name, argv):
    '''Call the subcommand with the given name.
    '''
    prefix = __loader__.name
    fullname = f'{prefix}.{name}'
    loader = pkgutil.get_loader(fullname)
    mod = loader.load_module()
    mod.main(argv)


def description():
    '''Returns the description text.
    '''
    desc = 'Subcommands for working with NAM forecasts.\n\n'
    desc += 'subcommands:\n'
    for cmd in iter_subcommands():
        desc += f'  {cmd}\n'
    return desc


def main(argv):
    parser = argparse.ArgumentParser(
        description=description(),
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )

    parser.add_argument(
        'command',
        metavar='COMMAND',
        choices=list(iter_subcommands()),
        help='The subcommand to execute',
    )

    parser.add_argument(
        'argv',
        metavar='...',  # Matches the usage string generated by argparse.
        nargs=argparse.REMAINDER,
        help='Additional arguments are forwarded to the subcommand'
    )

    args = parser.parse_args(argv)
    call_subcommand(args.command, args.argv)
